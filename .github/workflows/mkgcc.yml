name: Build CyrOS Mobile gnome-control-center (gcc)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'

jobs:
  build:
    # you provided this runner in your snippet
    runs-on: ubuntu-24.04-arm

    env:
      # force GCC/G++ usage
      CC: gcc
      CXX: g++
      # Meson install prefix (adjust if you want a different prefix)
      PREFIX: /usr

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # allow selecting branch at dispatch time
          ref: ${{ github.event.inputs.branch }}
          submodules: 'recursive'

      - name: Show branch and commit
        run: |
          echo "Building branch: ${{ github.event.inputs.branch }}"
          git rev-parse --abbrev-ref HEAD || true
          git rev-parse --verify HEAD

      - name: Update apt and install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            ca-certificates \
            pkg-config \
            python3-pip \
            python3-venv \
            curl \
            gettext \
            intltool \
            gdb \
            cmake \
            libtool \
            autoconf \
            automake \
            # GNOME / GTK / common deps (best-effort list; add extras if needed)
            libglib2.0-dev \
            libgtk-4-dev \
            libgirepository1.0-dev \
            gir1.2-gtk-4.0 \
            gir1.2-gdkpixbuf-2.0 \
            libgtk-4-dev \
            libgdk-pixbuf2.0-dev \
            libpango1.0-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libpolkit-gobject-1-dev \
            libsecret-1-dev \
            libsystemd-dev \
            libx11-dev \
            libxml2-dev \
            libgudev-1.0-dev \
            # optional UI libs commonly needed
            libadwaita-1-dev || true
        # note: package list is intentionally broad; if a package isn't present on the runner apt repo
        # apt will return non-zero; the trailing "|| true" keeps the step from failing if libadwaita-1-dev
        # or others do not exist on the runner. Add/remove packages according to actual branch errors.

      - name: Install/upgrade Python tooling (meson, ninja)
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install --upgrade meson ninja

      - name: Export build variables (debug)
        run: |
          echo "CC=$CC"
          echo "CXX=$CXX"
          echo "MESON: $(meson --version || echo 'meson not found')"
          echo "NINJA: $(ninja --version || echo 'ninja not found')"

      - name: Configure Meson build directory
        run: |
          # create a fresh build dir
          rm -rf build
          # typical meson options - tweak as needed for the target branch
          meson setup build \
            --prefix=$PREFIX \
            -Dbuildtype=release \
            -Doptimization=2 \
            -Dintrospection=true \
            -Dgtk_doc=false \
            -Dtests=false \
            -Db_lto=false \
            -Dmanifest=true

      - name: Build with Ninja (parallel)
        run: |
          ninja -C build -v

      - name: Run unit tests (if available)
        if: always()
        run: |
          # run meson test (don't fail the whole workflow if tests are missing)
          if [ -d build ]; then
            meson test -C build --print-errorlogs || echo "Tests failed or none present"
          fi

      - name: Install to temporary staging directory
        run: |
          STAGING_DIR=$PWD/staging
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR"
          # Use DESTDIR to stage install artifacts (no sudo)
          ninja -C build install DESTDIR="$STAGING_DIR"

      - name: List staged files
        run: |
          echo "Staged files:"
          find staging -maxdepth 4 -type f | sed -n '1,200p' || true

      - name: Package staged files (tar.gz)
        run: |
          PACKAGE_NAME=gnome-control-center-${{ github.event.inputs.branch }}-${{ github.run_number }}-arm.tar.gz
          tar -C staging -czf "$PACKAGE_NAME" .
          echo "PACKAGE=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: gnome-control-center-build-${{ github.event.inputs.branch }}
          path: |
            staging
            ${{ env.PACKAGE }}

      - name: Print success message
        if: ${{ success() }}
        run: echo "Build finished — artifact uploaded."

      - name: Print failure debug info
        if: ${{ failure() }}
        run: |
          echo "Build failed — printing last 200 lines of ninja log if available"
          if [ -f build/meson-logs/meson-log.txt ]; then
            tail -n 200 build/meson-logs/meson-log.txt || true
          fi
          # show build files
          find build -maxdepth 3 -type f | sed -n '1,200p' || true
