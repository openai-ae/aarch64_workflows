name: Build CyrOS Mobile gnome-control-center

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build"
        required: true
        default: "main"

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install base build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            devscripts \
            build-essential \
            meson \
            ninja-build \
            pkg-config \
            gettext \
            gtk-doc-tools \
            libxml2-utils \
            equivs \
            lintian

      - name: Clone Droidian gnome-control-center
        run: |
          git clone https://github.com/droidian/gnome-control-center.git src
          cd src
          git checkout ${{ github.event.inputs.branch }} || true

      - name: Extract clean build dependencies
        run: |
          cd src
          echo "Extracting clean build dependency list..."
          awk '/^Build-Depends:/,/^(Build-Conflicts|Maintainer)/' debian/control \
            | sed 's/Build-Depends://g' \
            | tr -d '\n' \
            | sed 's/,/\n/g' \
            | sed 's/([^)]*)//g' \
            | sed 's/|.*//g' \
            | sed 's/<[^>]*>//g' \
            | sed 's/\[.*\]//g' \
            | sed 's/${.*}//g' \
            | tr -d ' ' \
            | sed '/^$/d' \
            > ../build-deps-clean.txt

          echo "== Clean build dependencies =="
          cat ../build-deps-clean.txt

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y $(cat ../build-deps-clean.txt)

      - name: Build Debian package
        run: |
          cd src
          dpkg-buildpackage -b -us -uc

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp -v *.deb artifacts/ || true
          cp -v *.changes artifacts/ || true
          cp -v *.build artifacts/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gnome-control-center-build
          path: artifacts
