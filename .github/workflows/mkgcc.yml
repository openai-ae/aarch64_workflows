name: Build CyrOS Mobile gnome-control-center (gcc)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'
      use_gcc13:
        description: 'Install and use gcc-13 (true/false)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    env:
      PREFIX: /usr

    steps:
      - name: Prepare runner
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git curl ca-certificates pkg-config python3-pip python3-venv \
            automake autoconf libtool cmake gettext intltool gdb \
            libglib2.0-dev libgirepository1.0-dev libgdk-pixbuf2.0-dev libgtk-4-dev \
            gir1.2-gtk-4.0 libpango1.0-dev libpolkit-gobject-1-dev libsecret-1-dev \
            libsystemd-dev libx11-dev libxml2-dev libgudev-1.0-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev gobject-introspection \
            libgobject-introspection-dev pkgconf || true

      - name: Optionally install gcc-13
        if: ${{ github.event.inputs.use_gcc13 == 'true' }}
        run: |
          set -eux
          sudo apt-get install -y gcc-13 g++-13 || true
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
          echo "Using gcc: $(gcc --version | head -n1)"

      - name: Clone Droidian repo and prepare sources
        run: |
          set -eux
          git clone https://github.com/droidian/gnome-control-center.git src
          cd src
          git fetch --all --tags
          git checkout "${{ github.event.inputs.branch }}" || git checkout -b tmp-build "${{ github.event.inputs.branch }}" || true
          # try submodules if they exist
          git submodule update --init --recursive || true
          ls -la
          pwd
          echo "Repo ready in src/"

      - name: Install Python tooling
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install --upgrade meson ninja

      - name: Meson configure (verbose)
        run: |
          set -eux
          cd src
          rm -rf build
          # allow meson to fetch wraps, but verbose so logs contain errors
          MESON_ARGS="--prefix=$PREFIX -Dbuildtype=release -Dtests=false"
          meson setup build $MESON_ARGS --verbose || true
          # print critical log for CI
          echo "===== meson log head ====="
          sed -n '1,400p' build/meson-logs/meson-log.txt || true
          echo "===== end meson log head ====="

      - name: Build
        run: |
          set -eux
          cd src
          ninja -C build -v

      - name: Install to staging dir
        run: |
          set -eux
          cd src
          STAGING="$PWD/staging"
          rm -rf "$STAGING"
          mkdir -p "$STAGING"
          ninja -C build install DESTDIR="$STAGING"

      - name: Package artifact
        run: |
          cd src
          tar -czf ../gnome-control-center-${{ github.event.inputs.branch }}.tar.gz staging

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gnome-control-center-${{ github.event.inputs.branch }}
          path: gnome-control-center-${{ github.event.inputs.branch }}.tar.gz

      - name: On failure - output meson logs
        if: failure()
        run: |
          echo "==== Meson logs ===="
          sed -n '1,500p' src/build/meson-logs/meson-log.txt || true
          echo "==== Ninja build log tail (/var/log) ===="
          if [ -f src/build/meson-logs/meson-log.txt ]; then tail -n 200 src/build/meson-logs/meson-log.txt || true; fi
          find src -maxdepth 3 -type f | sed -n '1,200p' || true
