name: Build CyrOS Mobile gnome-control-center (gcc)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    env:
      CC: gcc
      CXX: g++
      PREFIX: /usr

    steps:
      - name: Clone Droidian gnome-control-center repo
        run: |
          git clone https://github.com/droidian/gnome-control-center.git src
          cd src
          git fetch --all
          git checkout ${{ github.event.inputs.branch }} || true
          echo "Checked out branch:"
          git rev-parse --abbrev-ref HEAD

      - name: Install dependencies
        run: |
          set -eux
          sudo apt-get update
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            pkg-config \
            python3-pip \
            python3-venv \
            libglib2.0-dev \
            libgtk-4-dev \
            libgirepository1.0-dev \
            libgdk-pixbuf2.0-dev \
            libpango1.0-dev \
            libpolkit-gobject-1-dev \
            libsecret-1-dev \
            libsystemd-dev \
            libx11-dev \
            libxml2-dev \
            libgudev-1.0-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libpulse-dev \
            libadwaita-1-dev || true

      - name: Install meson + ninja
        run: |
          python3 -m pip install --upgrade meson ninja

      - name: Configure Meson build
        run: |
          cd src
          rm -rf build
          meson setup build \
            --prefix=$PREFIX \
            -Dbuildtype=release \
            -Dtests=false

      - name: Build
        run: |
          cd src
          ninja -C build -v

      - name: Install to staging dir
        run: |
          cd src
          STAGING=$PWD/staging
          mkdir -p "$STAGING"
          ninja -C build install DESTDIR="$STAGING"

      - name: Package artifact
        run: |
          cd src/staging
          tar -czf ../../gnome-control-center.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gnome-control-center-${{ github.event.inputs.branch }}
          path: gnome-control-center.tar.gz
